<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPPI LED æ§åˆ¶å™¨æ¼”ç¤º - PWM ä¼˜åŒ–ä¸æ¸©åº¦åŠ¨ç”»</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .control-section {
            grid-column: 1 / -1;
            text-align: center;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .status-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .status-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .status-card .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .temperature-display {
            text-align: center;
            margin: 20px 0;
        }

        .temp-gauge {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #4299e1 0deg,
                #48bb78 120deg,
                #ed8936 240deg,
                #e53e3e 360deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .temp-inner {
            width: 160px;
            height: 160px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        .temp-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2d3748;
        }

        .temp-unit {
            font-size: 1.2em;
            color: #718096;
        }

        .sampling-visualization {
            margin: 20px 0;
        }

        .sample-point {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            transition: all 0.3s ease;
        }

        .sample-point.best {
            background: #48bb78;
            width: 12px;
            height: 12px;
            box-shadow: 0 0 10px #48bb78;
        }

        .sample-point.good {
            background: #4299e1;
        }

        .sample-point.bad {
            background: #e53e3e;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .animation-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .pwm-bars {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .pwm-bar {
            width: 60px;
            height: 200px;
            background: #e2e8f0;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .pwm-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            transition: height 0.5s ease;
            border-radius: 5px;
        }

        .pwm-fill.red {
            background: linear-gradient(to top, #e53e3e, #fc8181);
        }

        .pwm-fill.blue {
            background: linear-gradient(to top, #3182ce, #63b3ed);
        }

        .pwm-label {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulsing {
            animation: pulse 2s infinite;
        }

        .log-panel {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.success {
            border-left-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }

        .log-entry.warning {
            border-left-color: #ed8936;
            background: rgba(237, 131, 54, 0.1);
        }

        .log-entry.error {
            border-left-color: #e53e3e;
            background: rgba(229, 62, 62, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ MPPI LED æ§åˆ¶å™¨æ¼”ç¤º</h1>
            <p>å®æ—¶å±•ç¤ºæ¨¡å‹é¢„æµ‹è·¯å¾„ç§¯åˆ†æ§åˆ¶å™¨çš„ PWM ä¼˜åŒ–è¿‡ç¨‹ä¸æ¸©åº¦åŠ¨æ€å˜åŒ–</p>
        </div>

        <div class="dashboard">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="panel control-section">
                <h3>ğŸ® æ§åˆ¶é¢æ¿</h3>
                <div class="animation-controls">
                    <button class="btn" id="startBtn" onclick="startOptimization()">å¼€å§‹ä¼˜åŒ–</button>
                    <button class="btn" id="pauseBtn" onclick="pauseAnimation()" disabled>æš‚åœ</button>
                    <button class="btn" id="resetBtn" onclick="resetDemo()">é‡ç½®</button>
                    <button class="btn" id="stepBtn" onclick="stepOptimization()">å•æ­¥æ‰§è¡Œ</button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">å‡†å¤‡å¼€å§‹ä¼˜åŒ–...</p>
            </div>

            <!-- å½“å‰çŠ¶æ€æ˜¾ç¤º -->
            <div class="panel">
                <h3>ğŸ“Š å½“å‰çŠ¶æ€</h3>
                <div class="status-display">
                    <div class="status-card">
                        <h4>R é€šé“ PWM</h4>
                        <div class="value" id="currentR">33.3%</div>
                    </div>
                    <div class="status-card">
                        <h4>B é€šé“ PWM</h4>
                        <div class="value" id="currentB">6.7%</div>
                    </div>
                    <div class="status-card">
                        <h4>PPFD</h4>
                        <div class="value" id="currentPPFD">200</div>
                    </div>
                    <div class="status-card">
                        <h4>åŠŸç‡</h4>
                        <div class="value" id="currentPower">30W</div>
                    </div>
                </div>
            </div>

            <!-- æ¸©åº¦æ˜¾ç¤º -->
            <div class="panel">
                <h3>ğŸŒ¡ï¸ æ¸©åº¦ç›‘æ§</h3>
                <div class="temperature-display">
                    <div class="temp-gauge">
                        <div class="temp-inner">
                            <div class="temp-value" id="tempValue">23.0</div>
                            <div class="temp-unit">Â°C</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #718096;">ç›®æ ‡èŒƒå›´: 20-29Â°C</p>
                </div>
            </div>

            <!-- PWM å¯è§†åŒ– -->
            <div class="panel">
                <h3>ğŸ’¡ PWM è¾“å‡º</h3>
                <div class="pwm-bars">
                    <div>
                        <div class="pwm-bar">
                            <div class="pwm-fill red" id="redBar" style="height: 33.3%"></div>
                        </div>
                        <div class="pwm-label">çº¢å…‰ (R)</div>
                        <div id="redValue">33.3%</div>
                    </div>
                    <div>
                        <div class="pwm-bar">
                            <div class="pwm-fill blue" id="blueBar" style="height: 6.7%"></div>
                        </div>
                        <div class="pwm-label">è“å…‰ (B)</div>
                        <div id="blueValue">6.7%</div>
                    </div>
                </div>
                <p style="text-align: center; color: #718096; margin-top: 10px;">
                    R:B æ¯”ä¾‹ = <span id="ratioValue">5.0:1</span>
                </p>
            </div>
        </div>

        <!-- å›¾è¡¨åŒºåŸŸ -->
        <div class="panel">
            <h3>ğŸ“ˆ MPPI é‡‡æ ·ä¸æˆæœ¬åˆ†æ</h3>
            <div class="chart-container">
                <canvas id="samplingChart"></canvas>
            </div>
        </div>

        <div class="panel">
            <h3>ğŸ”¥ æ¸©åº¦å˜åŒ–æ›²çº¿ (15åˆ†é’Ÿé¢„æµ‹)</h3>
            <div class="chart-container">
                <canvas id="temperatureChart"></canvas>
            </div>
        </div>

        <!-- æ—¥å¿—é¢æ¿ -->
        <div class="panel">
            <h3>ğŸ“ ä¼˜åŒ–æ—¥å¿—</h3>
            <div class="log-panel" id="logPanel">
                <div class="log-entry">ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼Œç­‰å¾…å¼€å§‹ä¼˜åŒ–...</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let isRunning = false;
        let isPaused = false;
        let currentStep = 0;
        const maxSteps = 10; // æ”¹ä¸º10æ­¥é¢„æµ‹
        let animationId = null;
        let samplingChart = null;
        let temperatureChart = null;
        
        // MPPI å‚æ•°
        const mppiParams = {
            numSamples: 300,
            horizon: 10,
            dt: 1.0,
            baseTemp: 23.0,
            thermalResistance: 0.2,
            timeConstant: 1800.0,
            rbRatio: 5.0
        };

        // å½“å‰çŠ¶æ€
        let currentState = {
            temperature: 23.0,
            rPwm: 33.3,
            bPwm: 6.7,
            ppfd: 200,
            power: 30,
            cost: 0
        };

        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // é”€æ¯ç°æœ‰å›¾è¡¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (samplingChart) {
                samplingChart.destroy();
            }
            if (temperatureChart) {
                temperatureChart.destroy();
            }
            
            // é‡‡æ ·å›¾è¡¨
            const samplingCtx = document.getElementById('samplingChart').getContext('2d');
            samplingChart = new Chart(samplingCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'é‡‡æ ·ç‚¹',
                        data: [],
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        pointRadius: 4
                    }, {
                        label: 'æœ€ä¼˜ç‚¹',
                        data: [],
                        backgroundColor: 'rgba(72, 187, 120, 0.8)',
                        borderColor: 'rgba(72, 187, 120, 1)',
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'R é€šé“ PWM (%)'
                            },
                            min: 0,
                            max: 100
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'B é€šé“ PWM (%)'
                            },
                            min: 0,
                            max: 20
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `R: ${context.parsed.x.toFixed(1)}%, B: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });

            // æ¸©åº¦å›¾è¡¨ - 10æ­¥é¢„æµ‹
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: ['å½“å‰'],
                    datasets: [
                        {
                            label: 'å½“å‰æ¸©åº¦',
                            data: [currentState.temperature],
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.3)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            fill: false
                        },
                        {
                            label: '10æ­¥é¢„æµ‹',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3
                        },
                        {
                            label: 'å½“å‰æ­¥éª¤',
                            data: [currentState.temperature],
                            borderColor: '#ffd93d',
                            backgroundColor: '#ffd93d',
                            borderWidth: 0,
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 22,
                            max: 35,
                            title: {
                                display: true,
                                text: 'æ¸©åº¦ (Â°C)',
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'æ—¶é—´',
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'MPPI 10æ­¥æ¸©åº¦é¢„æµ‹æ›²çº¿',
                            color: '#ffffff',
                            font: {
                                size: 16
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // ç”Ÿæˆ MPPI é‡‡æ ·ç‚¹ï¼ˆä½¿ç”¨çœŸå®æ•°æ®æˆ–æ¨¡æ‹Ÿæ•°æ®ï¼‰
         function generateSamples() {
             if (demoData && demoData.sampling_data && demoData.sampling_data.all_samples) {
                 // ä½¿ç”¨çœŸå®æ•°æ®
                 return demoData.sampling_data.all_samples.map(sample => ({
                     r: sample.r || sample.r_pwm || 0,
                     b: sample.b || sample.b_pwm || 0,
                     cost: sample.cost || 0
                 }));
             } else {
                 // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                 const samples = [];
                 const baseR = currentState.rPwm;
                 const baseB = currentState.bPwm;
                 
                 for (let i = 0; i < mppiParams.numSamples; i++) {
                     // ç»´æŒ 5:1 æ¯”ä¾‹çš„é‡‡æ ·
                     const totalPwm = (baseR + baseB) + (Math.random() - 0.5) * 40;
                     const clampedTotal = Math.max(5, Math.min(100, totalPwm));
                     
                     const r = clampedTotal * (5/6);
                     const b = clampedTotal * (1/6);
                     
                     const cost = calculateCost(r, b);
                     samples.push({ r, b, cost });
                 }
                 
                 return samples.sort((a, b) => a.cost - b.cost);
             }
         }

        // è®¡ç®—æˆæœ¬å‡½æ•°
        function calculateCost(r, b) {
            const ppfd = calculatePPFD(r, b);
            const power = calculatePower(r, b);
            const temp = predictTemperature(r, b);
            
            // å…‰åˆä½œç”¨æ”¶ç›Š (è´Ÿå€¼ï¼Œè¶Šå¤§è¶Šå¥½)
            const photoBenefit = -ppfd * 0.05;
            
            // PWM æƒ©ç½š
            const pwmPenalty = (r*r + b*b) * 0.001;
            
            // åŠŸç‡æƒ©ç½š
            const powerPenalty = power * power * 0.01;
            
            // æ¸©åº¦çº¦æŸæƒ©ç½š
            let tempPenalty = 0;
            if (temp > 29) tempPenalty = Math.pow(temp - 29, 2) * 1000;
            if (temp < 20) tempPenalty = Math.pow(20 - temp, 2) * 1000;
            
            return photoBenefit + pwmPenalty + powerPenalty + tempPenalty;
        }

        // è®¡ç®— PPFD
        function calculatePPFD(r, b) {
            return r * 6.2 + b * 8.5;
        }

        // è®¡ç®—åŠŸç‡
        function calculatePower(r, b) {
            return r * 0.8 + b * 0.9;
        }

        // é¢„æµ‹æ¸©åº¦
        function predictTemperature(r, b) {
            const power = calculatePower(r, b);
            const heatGeneration = power * 0.7;
            return currentState.temperature + heatGeneration * mppiParams.thermalResistance;
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            document.getElementById('currentR').textContent = currentState.rPwm.toFixed(1) + '%';
            document.getElementById('currentB').textContent = currentState.bPwm.toFixed(1) + '%';
            document.getElementById('currentPPFD').textContent = currentState.ppfd.toFixed(0);
            document.getElementById('currentPower').textContent = currentState.power.toFixed(1) + 'W';
            document.getElementById('tempValue').textContent = currentState.temperature.toFixed(1);
            
            // æ›´æ–° PWM æ¡å½¢å›¾
            document.getElementById('redBar').style.height = currentState.rPwm + '%';
            document.getElementById('blueBar').style.height = currentState.bPwm + '%';
            document.getElementById('redValue').textContent = currentState.rPwm.toFixed(1) + '%';
            document.getElementById('blueValue').textContent = currentState.bPwm.toFixed(1) + '%';
            
            // æ›´æ–°æ¯”ä¾‹
            const ratio = (currentState.rPwm / currentState.bPwm).toFixed(1);
            document.getElementById('ratioValue').textContent = ratio + ':1';
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // å¼€å§‹ä¼˜åŒ–
        function startOptimization() {
            if (isRunning) return;
            
            isRunning = true;
            isPaused = false;
            currentStep = 0;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resetBtn').disabled = true;
            
            addLog('å¼€å§‹ MPPI ä¼˜åŒ–è¿‡ç¨‹...', 'success');
            runOptimizationStep();
        }

        // ç”ŸæˆMPPIé¢„æµ‹æ›²çº¿ï¼š300æ¬¡é‡‡æ ·ï¼Œæ¯æ¬¡10æ­¥é¢„æµ‹ï¼Œç­›é€‰æœ€å¥½çš„3æ¬¡
        let predictionTrajectories = [];
        let bestTrajectories = [];
        
        function generatePredictionCurve() {
            predictionTrajectories = [];
            bestTrajectories = [];
            
            addLog('å¼€å§‹MPPIé‡‡æ ·ï¼šç”Ÿæˆ300æ¬¡é¢„æµ‹è½¨è¿¹...', 'info');
            
            // ç”Ÿæˆ300æ¬¡é‡‡æ ·é¢„æµ‹
            for (let sampleIdx = 0; sampleIdx < 300; sampleIdx++) {
                const trajectory = generateSingleTrajectory(sampleIdx);
                predictionTrajectories.push(trajectory);
            }
            
            // éšæœºé€‰æ‹©3æ¡è½¨è¿¹è¿›è¡Œå±•ç¤º
            const shuffled = [...predictionTrajectories].sort(() => 0.5 - Math.random());
            bestTrajectories = shuffled.slice(0, 3);
            
            addLog(`å®Œæˆ300æ¬¡é‡‡æ ·ï¼Œéšæœºé€‰æ‹©3æ¡è½¨è¿¹å±•ç¤º`, 'success');
            addLog(`è½¨è¿¹1æˆæœ¬: ${bestTrajectories[0].totalCost.toFixed(2)}`, 'info');
            addLog(`è½¨è¿¹2æˆæœ¬: ${bestTrajectories[1].totalCost.toFixed(2)}`, 'info');
            addLog(`è½¨è¿¹3æˆæœ¬: ${bestTrajectories[2].totalCost.toFixed(2)}`, 'info');
        }
        
        function generateSingleTrajectory(sampleIdx) {
            let tempState = { ...currentState };
            const steps = [];
            let totalCost = 0;
            
            // ä¸ºè¿™ä¸ªè½¨è¿¹ç”Ÿæˆ10æ­¥æ§åˆ¶åºåˆ—
            const controlSequence = generateRandomControlSequence();
            
            for (let i = 0; i < 10; i++) {
                const control = controlSequence[i];
                
                // ä¸€é˜¶çƒ­åŠ›å­¦åŠ¨æ€æ¨¡å‹
                const powerInput = calculatePower(control.r, control.b);
                const ambientTemp = 23.0;
                const thermalResistance = 0.8; // çƒ­é˜» (Â°C/W)
                const thermalCapacitance = 1200; // çƒ­å®¹ (J/Â°C)
                const dt = 900; // æ—¶é—´æ­¥é•¿ (ç§’)
                
                // ä¸€é˜¶çƒ­åŠ›å­¦æ–¹ç¨‹: C * dT/dt = P - (T - T_amb) / R
                // ç¦»æ•£åŒ–: T(k+1) = T(k) + dt/C * [P - (T(k) - T_amb) / R]
                const steadyStateTemp = ambientTemp + powerInput * thermalResistance;
                const timeConstant = thermalResistance * thermalCapacitance;
                const alpha = dt / timeConstant;
                
                tempState.temperature = tempState.temperature + alpha * (steadyStateTemp - tempState.temperature);
                
                // è®¡ç®—è¿™ä¸€æ­¥çš„æˆæœ¬
                const stepCost = calculateStepCost(control.r, control.b, tempState.temperature);
                totalCost += stepCost;
                
                steps.push({
                    step: i + 1,
                    time: (i + 1) * 15,
                    temperature: tempState.temperature,
                    rPwm: control.r,
                    bPwm: control.b,
                    ppfd: calculatePPFD(control.r, control.b),
                    power: powerInput,
                    cost: stepCost
                });
            }
            
            return {
                sampleIdx: sampleIdx,
                steps: steps,
                totalCost: totalCost
            };
        }
        
        function generateRandomControlSequence() {
            const sequence = [];
            const baseR = currentState.rPwm;
            const baseB = currentState.bPwm;
            
            for (let i = 0; i < 10; i++) {
                // æ·»åŠ éšæœºæ‰°åŠ¨ï¼Œä½†ä¿æŒåˆç†èŒƒå›´
                const noiseR = (Math.random() - 0.5) * 20; // Â±10 PWM
                const noiseB = (Math.random() - 0.5) * 20;
                
                const r = Math.max(0, Math.min(100, baseR + noiseR));
                const b = Math.max(0, Math.min(100, baseB + noiseB));
                
                sequence.push({ r, b });
            }
            
            return sequence;
        }
        
        function calculateStepCost(r, b, temperature) {
            const ppfd = calculatePPFD(r, b);
            const power = calculatePower(r, b);
            
            // å…‰åˆä½œç”¨æ”¶ç›Š (è´Ÿå€¼ï¼Œè¶Šå¤§è¶Šå¥½)
            const photoBenefit = -ppfd * 0.05;
            
            // PWM æƒ©ç½š
            const pwmPenalty = (r*r + b*b) * 0.001;
            
            // åŠŸç‡æƒ©ç½š
            const powerPenalty = power * power * 0.01;
            
            // æ¸©åº¦çº¦æŸæƒ©ç½š
            let tempPenalty = 0;
            if (temperature > 29) tempPenalty = Math.pow(temperature - 29, 2) * 100;
            if (temperature < 20) tempPenalty = Math.pow(20 - temperature, 2) * 100;
            
            return photoBenefit + pwmPenalty + powerPenalty + tempPenalty;
        }

        // è¿è¡Œä¼˜åŒ–æ­¥éª¤ - æ”¹ä¸ºå±•ç¤ºé¢„æµ‹æ­¥éª¤
        function runOptimizationStep() {
            if (!isRunning || isPaused) return;
            
            // ç¬¬ä¸€æ­¥ç”Ÿæˆé¢„æµ‹æ›²çº¿
            if (currentStep === 0) {
                generatePredictionCurve();
                updateTemperatureChart(); // ç«‹å³æ›´æ–°å›¾è¡¨æ˜¾ç¤º3æ¡è½¨è¿¹
            }
            
            currentStep++;
            const progress = Math.min(currentStep / 10, 1) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `é¢„æµ‹æ­¥éª¤: ${currentStep}/10 æ­¥`;
            
            addLog(`ç¬¬ ${currentStep} æ­¥: å±•ç¤ºé‡‡æ ·è½¨è¿¹é¢„æµ‹...`, 'info');
            
            // ä½¿ç”¨æœ€ä¼˜è½¨è¿¹çš„æ•°æ®æ¥æ›´æ–°å½“å‰çŠ¶æ€
            if (bestTrajectories && bestTrajectories.length > 0 && bestTrajectories[0].steps[currentStep - 1]) {
                const step = bestTrajectories[0].steps[currentStep - 1];
                currentState.temperature = step.temperature;
                currentState.rPwm = step.rPwm;
                currentState.bPwm = step.bPwm;
                currentState.ppfd = step.ppfd;
                currentState.power = step.power;
                
                const ratio = currentState.bPwm > 0 ? (currentState.rPwm / currentState.bPwm).toFixed(1) : 'N/A';
                addLog(`é‡‡æ ·è½¨è¿¹ç¬¬ ${currentStep} æ­¥: æ¸©åº¦=${step.temperature.toFixed(2)}Â°C, R:B=${ratio}, PPFD=${step.ppfd.toFixed(0)}`, 'info');
                
                // ç”Ÿæˆé‡‡æ ·ç‚¹ç”¨äºé‡‡æ ·å›¾è¡¨æ˜¾ç¤º
                const samples = generateSamplesForDisplay();
                updateSamplingChart(samples);
            }
            
            // æ›´æ–°æ˜¾ç¤º
            updateDisplay();
            
            if (currentStep >= maxSteps) {
                completeOptimization();
            } else {
                setTimeout(runOptimizationStep, 1000);
            }
        }
        
        // ä¸ºæ˜¾ç¤ºç”Ÿæˆé‡‡æ ·ç‚¹
        function generateSamplesForDisplay() {
            const samples = [];
            const baseR = currentState.rPwm;
            const baseB = currentState.bPwm;
            
            for (let i = 0; i < 50; i++) { // ç”Ÿæˆ50ä¸ªç‚¹ç”¨äºæ˜¾ç¤º
                const noiseR = (Math.random() - 0.5) * 30;
                const noiseB = (Math.random() - 0.5) * 30;
                
                const r = Math.max(0, Math.min(100, baseR + noiseR));
                const b = Math.max(0, Math.min(100, baseB + noiseB));
                const cost = calculateStepCost(r, b, currentState.temperature);
                
                samples.push({ r, b, cost });
            }
            
            return samples.sort((a, b) => a.cost - b.cost);
        }
        
        // æ›´æ–°é‡‡æ ·å›¾è¡¨
        function updateSamplingChart(samples) {
            const sampleData = samples.map(s => ({x: s.r, y: s.b}));
            const bestSample = samples[0];
            
            samplingChart.data.datasets[0].data = sampleData;
            samplingChart.data.datasets[1].data = [{x: bestSample.r, y: bestSample.b}];
            samplingChart.update('none');
            
            const ratio = bestSample.b > 0 ? (bestSample.r / bestSample.b).toFixed(1) : 'âˆ';
            addLog(`âœ… ç¬¬ ${currentStep} æ­¥å®Œæˆ: R=${bestSample.r.toFixed(1)}%, B=${bestSample.b.toFixed(1)}%, æ¯”ä¾‹=${ratio}:1, æˆæœ¬=${bestSample.cost.toFixed(2)}`, 'success');
        }

        // æ›´æ–°æ¸©åº¦å›¾è¡¨
        function updateTemperatureChart() {
            if (!temperatureChart || !temperatureChart.data) return;
            
            // å‡†å¤‡æ—¶é—´æ ‡ç­¾
            const labels = ['å½“å‰'];
            for (let i = 1; i <= 10; i++) {
                labels.push(`${i * 15}åˆ†é’Ÿ`);
            }
            
            // å‡†å¤‡å½“å‰çŠ¶æ€æ•°æ®
            const currentData = [currentState.temperature];
            for (let i = 1; i <= 10; i++) {
                currentData.push(null);
            }
            
            // å‡†å¤‡é«˜äº®æ•°æ®ï¼ˆåªæ˜¾ç¤ºå½“å‰ç‚¹ï¼‰
            const highlightData = [currentState.temperature];
            for (let i = 1; i <= 10; i++) {
                highlightData.push(null);
            }
            
            // æ¸…é™¤æ—§çš„é¢„æµ‹è½¨è¿¹æ•°æ®é›†ï¼Œä¿ç•™å‰3ä¸ªåŸºç¡€æ•°æ®é›†
            temperatureChart.data.datasets = temperatureChart.data.datasets.slice(0, 3);
            
            // æ·»åŠ 3æ¡æœ€ä¼˜é¢„æµ‹è½¨è¿¹
            if (bestTrajectories && bestTrajectories.length >= 3) {
                const colors = [
                    { border: '#ff6b6b', bg: 'rgba(255, 107, 107, 0.1)' }, // çº¢è‰² - æœ€ä¼˜
                    { border: '#4ecdc4', bg: 'rgba(78, 205, 196, 0.1)' }, // é’è‰² - ç¬¬äºŒä¼˜
                    { border: '#45b7d1', bg: 'rgba(69, 183, 209, 0.1)' }  // è“è‰² - ç¬¬ä¸‰ä¼˜
                ];
                
                bestTrajectories.forEach((trajectory, index) => {
                    if (index < 3) {
                        const trajectoryData = [null]; // å½“å‰ç‚¹ä¸ºç©º
                        trajectory.steps.forEach(step => {
                            trajectoryData.push(step.temperature);
                        });
                        
                        temperatureChart.data.datasets.push({
                            label: `é‡‡æ ·è½¨è¿¹ ${index + 1} (æˆæœ¬: ${trajectory.totalCost.toFixed(1)})`,
                            data: trajectoryData,
                            borderColor: colors[index].border,
                            backgroundColor: colors[index].bg,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        });
                    }
                });
            }
            
            // æ›´æ–°å›¾è¡¨
            temperatureChart.data.labels = labels;
            temperatureChart.data.datasets[0].data = currentData; // å½“å‰æ¸©åº¦
            temperatureChart.data.datasets[1].data = []; // æ¸…ç©º10æ­¥é¢„æµ‹æ•°æ®é›†
            temperatureChart.data.datasets[2].data = highlightData; // å½“å‰æ­¥éª¤é«˜äº®
            
            temperatureChart.update('none');
        }

        // å®Œæˆä¼˜åŒ–
        function completeOptimization() {
            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resetBtn').disabled = false;
            document.getElementById('progressText').textContent = 'ä¼˜åŒ–å®Œæˆï¼';
            
            addLog('MPPI ä¼˜åŒ–å®Œæˆï¼', 'success');
            addLog(`æœ€ç»ˆç»“æœ: R=${currentState.rPwm.toFixed(1)}%, B=${currentState.bPwm.toFixed(1)}%, PPFD=${currentState.ppfd.toFixed(0)}, æ¸©åº¦=${currentState.temperature.toFixed(1)}Â°C`, 'success');
        }

        // æš‚åœåŠ¨ç”»
        function pauseAnimation() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? 'ç»§ç»­' : 'æš‚åœ';
            
            if (!isPaused) {
                runOptimizationStep();
            }
        }

        // é‡ç½®æ¼”ç¤º
        function resetDemo() {
            isRunning = false;
            isPaused = false;
            currentStep = 0;
            
            currentState = {
                temperature: 23.0,
                rPwm: 33.3,
                bPwm: 6.7,
                ppfd: 200,
                power: 30,
                cost: 0
            };
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resetBtn').disabled = false;
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = 'å‡†å¤‡å¼€å§‹ä¼˜åŒ–...';
            
            // æ¸…ç©ºå›¾è¡¨
            samplingChart.data.datasets[0].data = [];
            samplingChart.data.datasets[1].data = [];
            samplingChart.update();
            
            temperatureChart.data.datasets[0].data = Array(16).fill(23);
            temperatureChart.update();
            
            // æ¸…ç©ºæ—¥å¿—
            document.getElementById('logPanel').innerHTML = '<div class="log-entry">ç³»ç»Ÿé‡ç½®å®Œæˆï¼Œç­‰å¾…å¼€å§‹ä¼˜åŒ–...</div>';
            
            updateDisplay();
        }

        // å•æ­¥æ‰§è¡Œ
        function stepOptimization() {
            if (isRunning) return;
            
            isRunning = true;
            isPaused = true;
            runOptimizationStep();
            isRunning = false;
        }

        // åŠ è½½çœŸå®çš„ MPPI æ•°æ®
        let demoData = null;
        
        // å¼‚æ­¥åŠ è½½æ•°æ®
        async function loadDemoData() {
            try {
                const response = await fetch('mppi_demo_data.json');
                if (!response.ok) {
                    throw new Error('æ— æ³•åŠ è½½æ¼”ç¤ºæ•°æ®');
                }
                demoData = await response.json();
                console.log('âœ… æˆåŠŸåŠ è½½çœŸå® MPPI æ•°æ®');
                
                // æ•°æ®åŠ è½½å®Œæˆååˆå§‹åŒ–æ¼”ç¤º
                initializeDemo();
            } catch (error) {
                console.warn('âš ï¸ æ— æ³•åŠ è½½çœŸå®æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®:', error);
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºå¤‡é€‰
                demoData = {
                    initial_state: {
                        temperature: 23.0,
                        r_pwm: 33.3,
                        b_pwm: 6.7,
                        ppfd: 200,
                        power: 30
                    },
                    optimization_result: {
                        r_pwm: 37.6,
                        b_pwm: 7.5,
                        ppfd: 246,
                        temperature: 23.0,
                        power: 36.0,
                        photosynthesis: 8.2,
                        cost: -82.0,
                        ratio: 5.0
                    },
                    sampling_data: {
                        all_samples: generateSampleData(),
                        best_sample: null,
                        worst_sample: null,
                        num_samples: 300
                    },
                    temperature_predictions: generateTemperatureData(),
                    multi_step_optimization: generateMultiStepData()
                };
                
                // è®¾ç½®æœ€ä½³å’Œæœ€å·®æ ·æœ¬
                demoData.sampling_data.all_samples.sort((a, b) => a.cost - b.cost);
                demoData.sampling_data.best_sample = demoData.sampling_data.all_samples[0];
                demoData.sampling_data.worst_sample = demoData.sampling_data.all_samples[demoData.sampling_data.all_samples.length - 1];
                
                initializeDemo();
            }
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿé‡‡æ ·æ•°æ®
        function generateSampleData() {
            const samples = [];
            for (let i = 0; i < 300; i++) {
                const r = Math.random() * 100;
                const b = Math.random() * 20;
                const cost = Math.random() * 200 - 100;
                samples.push({ r_pwm: r, b_pwm: b, cost: cost });
            }
            return samples;
        }

        // ç”Ÿæˆæ¨¡æ‹Ÿæ¸©åº¦æ•°æ®
        function generateTemperatureData() {
            const temps = [];
            let temp = 23.0;
            for (let i = 0; i <= 15; i++) {
                temps.push(temp);
                temp += (Math.random() - 0.5) * 0.5;
            }
            return temps;
        }

        // ç”Ÿæˆå¤šæ­¥ä¼˜åŒ–æ•°æ®
        function generateMultiStepData() {
            const steps = [];
            for (let i = 0; i < 10; i++) {
                steps.push({
                    step: i + 1,
                    r_pwm: 33.3 + i * 0.5,
                    b_pwm: 6.7 + i * 0.1,
                    cost: -50 - i * 3
                });
            }
            return steps;
        }

        // åˆå§‹åŒ–æ¼”ç¤º
        function initializeDemo() {
            currentStep = 0;
            
            // å¦‚æœæœ‰çœŸå®æ•°æ®ï¼Œä½¿ç”¨çœŸå®çš„åˆå§‹çŠ¶æ€
            if (demoData && demoData.initial_state) {
                currentState.temperature = demoData.initial_state.temperature;
                currentState.rPwm = demoData.initial_state.r_pwm;
                currentState.bPwm = demoData.initial_state.b_pwm;
                currentState.ppfd = demoData.initial_state.ppfd || 0;
                currentState.power = demoData.initial_state.power || 0;
            }
            
            // å•æ¬¡MPPIæ¼”ç¤ºï¼šå±•ç¤ºå†…éƒ¨10æ­¥é¢„æµ‹
            addLog(`å•æ¬¡MPPIæ¼”ç¤º - å±•ç¤ºå†…éƒ¨10æ­¥æ¸©åº¦é¢„æµ‹`, 'info');
            addLog(`åˆå§‹çŠ¶æ€: T=${currentState.temperature.toFixed(1)}Â°C, R=${currentState.rPwm.toFixed(1)}, B=${currentState.bPwm.toFixed(1)}`, 'info');
            
            initCharts();
             
             // é¢„ç”Ÿæˆé¢„æµ‹æ›²çº¿ç”¨äºå›¾è¡¨æ˜¾ç¤º
             generatePredictionCurve();
             
             updateDisplay();
             updateTemperatureChart();
            
            // æ˜¾ç¤ºæ•°æ®æ¥æºä¿¡æ¯
            const dataSource = demoData && demoData.optimization_result ? 'çœŸå® MPPI æ•°æ®' : 'æ¨¡æ‹Ÿæ•°æ®';
            addLog(`ğŸ“Š ä½¿ç”¨ ${dataSource} è¿›è¡Œæ¼”ç¤º`, 'info');
            
            if (demoData && demoData.optimization_result) {
                const result = demoData.optimization_result;
                addLog(`ğŸ¯ æœ€ä¼˜è§£: R=${result.r_pwm.toFixed(1)}%, B=${result.b_pwm.toFixed(1)}%, æ¯”ä¾‹=${result.ratio.toFixed(1)}:1`, 'success');
            }
        }

        // é¡µé¢åŠ è½½å®ŒæˆååŠ è½½æ•°æ®
        window.addEventListener('load', function() {
            loadDemoData();
        });
    </script>
</body>
</html>