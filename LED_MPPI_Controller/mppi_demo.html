<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MPPI LED 控制器演示 - PWM 优化与温度动画</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel h3 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.4em;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
        }

        .control-section {
            grid-column: 1 / -1;
            text-align: center;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            margin: 10px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .status-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .status-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .status-card h4 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .status-card .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .temperature-display {
            text-align: center;
            margin: 20px 0;
        }

        .temp-gauge {
            width: 200px;
            height: 200px;
            margin: 0 auto;
            position: relative;
            border-radius: 50%;
            background: conic-gradient(
                from 0deg,
                #4299e1 0deg,
                #48bb78 120deg,
                #ed8936 240deg,
                #e53e3e 360deg
            );
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .temp-inner {
            width: 160px;
            height: 160px;
            background: white;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
        }

        .temp-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2d3748;
        }

        .temp-unit {
            font-size: 1.2em;
            color: #718096;
        }

        .sampling-visualization {
            margin: 20px 0;
        }

        .sample-point {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            position: absolute;
            transition: all 0.3s ease;
        }

        .sample-point.best {
            background: #48bb78;
            width: 12px;
            height: 12px;
            box-shadow: 0 0 10px #48bb78;
        }

        .sample-point.good {
            background: #4299e1;
        }

        .sample-point.bad {
            background: #e53e3e;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .animation-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 20px 0;
        }

        .pwm-bars {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
        }

        .pwm-bar {
            width: 60px;
            height: 200px;
            background: #e2e8f0;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .pwm-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            transition: height 0.5s ease;
            border-radius: 5px;
        }

        .pwm-fill.red {
            background: linear-gradient(to top, #e53e3e, #fc8181);
        }

        .pwm-fill.blue {
            background: linear-gradient(to top, #3182ce, #63b3ed);
        }

        .pwm-label {
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulsing {
            animation: pulse 2s infinite;
        }

        .log-panel {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 10px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #667eea;
            padding-left: 10px;
        }

        .log-entry.success {
            border-left-color: #48bb78;
            background: rgba(72, 187, 120, 0.1);
        }

        .log-entry.warning {
            border-left-color: #ed8936;
            background: rgba(237, 131, 54, 0.1);
        }

        .log-entry.error {
            border-left-color: #e53e3e;
            background: rgba(229, 62, 62, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 MPPI LED 控制器演示</h1>
            <p>实时展示模型预测路径积分控制器的 PWM 优化过程与温度动态变化</p>
        </div>

        <div class="dashboard">
            <!-- 控制面板 -->
            <div class="panel control-section">
                <h3>🎮 控制面板</h3>
                <div class="animation-controls">
                    <button class="btn" id="startBtn" onclick="startOptimization()">开始优化</button>
                    <button class="btn" id="pauseBtn" onclick="pauseAnimation()" disabled>暂停</button>
                    <button class="btn" id="resetBtn" onclick="resetDemo()">重置</button>
                    <button class="btn" id="stepBtn" onclick="stepOptimization()">单步执行</button>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">准备开始优化...</p>
            </div>

            <!-- 当前状态显示 -->
            <div class="panel">
                <h3>📊 当前状态</h3>
                <div class="status-display">
                    <div class="status-card">
                        <h4>R 通道 PWM</h4>
                        <div class="value" id="currentR">33.3%</div>
                    </div>
                    <div class="status-card">
                        <h4>B 通道 PWM</h4>
                        <div class="value" id="currentB">6.7%</div>
                    </div>
                    <div class="status-card">
                        <h4>PPFD</h4>
                        <div class="value" id="currentPPFD">200</div>
                    </div>
                    <div class="status-card">
                        <h4>功率</h4>
                        <div class="value" id="currentPower">30W</div>
                    </div>
                </div>
            </div>

            <!-- 温度显示 -->
            <div class="panel">
                <h3>🌡️ 温度监控</h3>
                <div class="temperature-display">
                    <div class="temp-gauge">
                        <div class="temp-inner">
                            <div class="temp-value" id="tempValue">23.0</div>
                            <div class="temp-unit">°C</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #718096;">目标范围: 20-29°C</p>
                </div>
            </div>

            <!-- PWM 可视化 -->
            <div class="panel">
                <h3>💡 PWM 输出</h3>
                <div class="pwm-bars">
                    <div>
                        <div class="pwm-bar">
                            <div class="pwm-fill red" id="redBar" style="height: 33.3%"></div>
                        </div>
                        <div class="pwm-label">红光 (R)</div>
                        <div id="redValue">33.3%</div>
                    </div>
                    <div>
                        <div class="pwm-bar">
                            <div class="pwm-fill blue" id="blueBar" style="height: 6.7%"></div>
                        </div>
                        <div class="pwm-label">蓝光 (B)</div>
                        <div id="blueValue">6.7%</div>
                    </div>
                </div>
                <p style="text-align: center; color: #718096; margin-top: 10px;">
                    R:B 比例 = <span id="ratioValue">5.0:1</span>
                </p>
            </div>
        </div>

        <!-- 图表区域 -->
        <div class="panel">
            <h3>📈 MPPI 采样与成本分析</h3>
            <div class="chart-container">
                <canvas id="samplingChart"></canvas>
            </div>
        </div>

        <div class="panel">
            <h3>🔥 温度变化曲线 (15分钟预测)</h3>
            <div class="chart-container">
                <canvas id="temperatureChart"></canvas>
            </div>
        </div>

        <!-- 日志面板 -->
        <div class="panel">
            <h3>📝 优化日志</h3>
            <div class="log-panel" id="logPanel">
                <div class="log-entry">系统初始化完成，等待开始优化...</div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let isRunning = false;
        let isPaused = false;
        let currentStep = 0;
        const maxSteps = 10; // 改为10步预测
        let animationId = null;
        let samplingChart = null;
        let temperatureChart = null;
        
        // MPPI 参数
        const mppiParams = {
            numSamples: 300,
            horizon: 10,
            dt: 1.0,
            baseTemp: 23.0,
            thermalResistance: 0.2,
            timeConstant: 1800.0,
            rbRatio: 5.0
        };

        // 当前状态
        let currentState = {
            temperature: 23.0,
            rPwm: 33.3,
            bPwm: 6.7,
            ppfd: 200,
            power: 30,
            cost: 0
        };

        // 初始化图表
        function initCharts() {
            // 销毁现有图表（如果存在）
            if (samplingChart) {
                samplingChart.destroy();
            }
            if (temperatureChart) {
                temperatureChart.destroy();
            }
            
            // 采样图表
            const samplingCtx = document.getElementById('samplingChart').getContext('2d');
            samplingChart = new Chart(samplingCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: '采样点',
                        data: [],
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        pointRadius: 4
                    }, {
                        label: '最优点',
                        data: [],
                        backgroundColor: 'rgba(72, 187, 120, 0.8)',
                        borderColor: 'rgba(72, 187, 120, 1)',
                        pointRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'R 通道 PWM (%)'
                            },
                            min: 0,
                            max: 100
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'B 通道 PWM (%)'
                            },
                            min: 0,
                            max: 20
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `R: ${context.parsed.x.toFixed(1)}%, B: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });

            // 温度图表 - 10步预测
            const tempCtx = document.getElementById('temperatureChart').getContext('2d');
            temperatureChart = new Chart(tempCtx, {
                type: 'line',
                data: {
                    labels: ['当前'],
                    datasets: [
                        {
                            label: '当前温度',
                            data: [currentState.temperature],
                            borderColor: '#4ecdc4',
                            backgroundColor: 'rgba(78, 205, 196, 0.3)',
                            borderWidth: 3,
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            fill: false
                        },
                        {
                            label: '10步预测',
                            data: [],
                            borderColor: '#ff6b6b',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            fill: true,
                            tension: 0.4,
                            pointRadius: 3
                        },
                        {
                            label: '当前步骤',
                            data: [currentState.temperature],
                            borderColor: '#ffd93d',
                            backgroundColor: '#ffd93d',
                            borderWidth: 0,
                            pointRadius: 8,
                            pointHoverRadius: 10,
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 22,
                            max: 35,
                            title: {
                                display: true,
                                text: '温度 (°C)',
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '时间',
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#ffffff'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        title: {
                            display: true,
                            text: 'MPPI 10步温度预测曲线',
                            color: '#ffffff',
                            font: {
                                size: 16
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        // 生成 MPPI 采样点（使用真实数据或模拟数据）
         function generateSamples() {
             if (demoData && demoData.sampling_data && demoData.sampling_data.all_samples) {
                 // 使用真实数据
                 return demoData.sampling_data.all_samples.map(sample => ({
                     r: sample.r || sample.r_pwm || 0,
                     b: sample.b || sample.b_pwm || 0,
                     cost: sample.cost || 0
                 }));
             } else {
                 // 使用模拟数据
                 const samples = [];
                 const baseR = currentState.rPwm;
                 const baseB = currentState.bPwm;
                 
                 for (let i = 0; i < mppiParams.numSamples; i++) {
                     // 维持 5:1 比例的采样
                     const totalPwm = (baseR + baseB) + (Math.random() - 0.5) * 40;
                     const clampedTotal = Math.max(5, Math.min(100, totalPwm));
                     
                     const r = clampedTotal * (5/6);
                     const b = clampedTotal * (1/6);
                     
                     const cost = calculateCost(r, b);
                     samples.push({ r, b, cost });
                 }
                 
                 return samples.sort((a, b) => a.cost - b.cost);
             }
         }

        // 计算成本函数
        function calculateCost(r, b) {
            const ppfd = calculatePPFD(r, b);
            const power = calculatePower(r, b);
            const temp = predictTemperature(r, b);
            
            // 光合作用收益 (负值，越大越好)
            const photoBenefit = -ppfd * 0.05;
            
            // PWM 惩罚
            const pwmPenalty = (r*r + b*b) * 0.001;
            
            // 功率惩罚
            const powerPenalty = power * power * 0.01;
            
            // 温度约束惩罚
            let tempPenalty = 0;
            if (temp > 29) tempPenalty = Math.pow(temp - 29, 2) * 1000;
            if (temp < 20) tempPenalty = Math.pow(20 - temp, 2) * 1000;
            
            return photoBenefit + pwmPenalty + powerPenalty + tempPenalty;
        }

        // 计算 PPFD
        function calculatePPFD(r, b) {
            return r * 6.2 + b * 8.5;
        }

        // 计算功率
        function calculatePower(r, b) {
            return r * 0.8 + b * 0.9;
        }

        // 预测温度
        function predictTemperature(r, b) {
            const power = calculatePower(r, b);
            const heatGeneration = power * 0.7;
            return currentState.temperature + heatGeneration * mppiParams.thermalResistance;
        }

        // 更新显示
        function updateDisplay() {
            document.getElementById('currentR').textContent = currentState.rPwm.toFixed(1) + '%';
            document.getElementById('currentB').textContent = currentState.bPwm.toFixed(1) + '%';
            document.getElementById('currentPPFD').textContent = currentState.ppfd.toFixed(0);
            document.getElementById('currentPower').textContent = currentState.power.toFixed(1) + 'W';
            document.getElementById('tempValue').textContent = currentState.temperature.toFixed(1);
            
            // 更新 PWM 条形图
            document.getElementById('redBar').style.height = currentState.rPwm + '%';
            document.getElementById('blueBar').style.height = currentState.bPwm + '%';
            document.getElementById('redValue').textContent = currentState.rPwm.toFixed(1) + '%';
            document.getElementById('blueValue').textContent = currentState.bPwm.toFixed(1) + '%';
            
            // 更新比例
            const ratio = (currentState.rPwm / currentState.bPwm).toFixed(1);
            document.getElementById('ratioValue').textContent = ratio + ':1';
        }

        // 添加日志
        function addLog(message, type = 'info') {
            const logPanel = document.getElementById('logPanel');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(logEntry);
            logPanel.scrollTop = logPanel.scrollHeight;
        }

        // 开始优化
        function startOptimization() {
            if (isRunning) return;
            
            isRunning = true;
            isPaused = false;
            currentStep = 0;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('resetBtn').disabled = true;
            
            addLog('开始 MPPI 优化过程...', 'success');
            runOptimizationStep();
        }

        // 生成MPPI预测曲线：300次采样，每次10步预测，筛选最好的3次
        let predictionTrajectories = [];
        let bestTrajectories = [];
        
        function generatePredictionCurve() {
            predictionTrajectories = [];
            bestTrajectories = [];
            
            addLog('开始MPPI采样：生成300次预测轨迹...', 'info');
            
            // 生成300次采样预测
            for (let sampleIdx = 0; sampleIdx < 300; sampleIdx++) {
                const trajectory = generateSingleTrajectory(sampleIdx);
                predictionTrajectories.push(trajectory);
            }
            
            // 随机选择3条轨迹进行展示
            const shuffled = [...predictionTrajectories].sort(() => 0.5 - Math.random());
            bestTrajectories = shuffled.slice(0, 3);
            
            addLog(`完成300次采样，随机选择3条轨迹展示`, 'success');
            addLog(`轨迹1成本: ${bestTrajectories[0].totalCost.toFixed(2)}`, 'info');
            addLog(`轨迹2成本: ${bestTrajectories[1].totalCost.toFixed(2)}`, 'info');
            addLog(`轨迹3成本: ${bestTrajectories[2].totalCost.toFixed(2)}`, 'info');
        }
        
        function generateSingleTrajectory(sampleIdx) {
            let tempState = { ...currentState };
            const steps = [];
            let totalCost = 0;
            
            // 为这个轨迹生成10步控制序列
            const controlSequence = generateRandomControlSequence();
            
            for (let i = 0; i < 10; i++) {
                const control = controlSequence[i];
                
                // 一阶热力学动态模型
                const powerInput = calculatePower(control.r, control.b);
                const ambientTemp = 23.0;
                const thermalResistance = 0.8; // 热阻 (°C/W)
                const thermalCapacitance = 1200; // 热容 (J/°C)
                const dt = 900; // 时间步长 (秒)
                
                // 一阶热力学方程: C * dT/dt = P - (T - T_amb) / R
                // 离散化: T(k+1) = T(k) + dt/C * [P - (T(k) - T_amb) / R]
                const steadyStateTemp = ambientTemp + powerInput * thermalResistance;
                const timeConstant = thermalResistance * thermalCapacitance;
                const alpha = dt / timeConstant;
                
                tempState.temperature = tempState.temperature + alpha * (steadyStateTemp - tempState.temperature);
                
                // 计算这一步的成本
                const stepCost = calculateStepCost(control.r, control.b, tempState.temperature);
                totalCost += stepCost;
                
                steps.push({
                    step: i + 1,
                    time: (i + 1) * 15,
                    temperature: tempState.temperature,
                    rPwm: control.r,
                    bPwm: control.b,
                    ppfd: calculatePPFD(control.r, control.b),
                    power: powerInput,
                    cost: stepCost
                });
            }
            
            return {
                sampleIdx: sampleIdx,
                steps: steps,
                totalCost: totalCost
            };
        }
        
        function generateRandomControlSequence() {
            const sequence = [];
            const baseR = currentState.rPwm;
            const baseB = currentState.bPwm;
            
            for (let i = 0; i < 10; i++) {
                // 添加随机扰动，但保持合理范围
                const noiseR = (Math.random() - 0.5) * 20; // ±10 PWM
                const noiseB = (Math.random() - 0.5) * 20;
                
                const r = Math.max(0, Math.min(100, baseR + noiseR));
                const b = Math.max(0, Math.min(100, baseB + noiseB));
                
                sequence.push({ r, b });
            }
            
            return sequence;
        }
        
        function calculateStepCost(r, b, temperature) {
            const ppfd = calculatePPFD(r, b);
            const power = calculatePower(r, b);
            
            // 光合作用收益 (负值，越大越好)
            const photoBenefit = -ppfd * 0.05;
            
            // PWM 惩罚
            const pwmPenalty = (r*r + b*b) * 0.001;
            
            // 功率惩罚
            const powerPenalty = power * power * 0.01;
            
            // 温度约束惩罚
            let tempPenalty = 0;
            if (temperature > 29) tempPenalty = Math.pow(temperature - 29, 2) * 100;
            if (temperature < 20) tempPenalty = Math.pow(20 - temperature, 2) * 100;
            
            return photoBenefit + pwmPenalty + powerPenalty + tempPenalty;
        }

        // 运行优化步骤 - 改为展示预测步骤
        function runOptimizationStep() {
            if (!isRunning || isPaused) return;
            
            // 第一步生成预测曲线
            if (currentStep === 0) {
                generatePredictionCurve();
                updateTemperatureChart(); // 立即更新图表显示3条轨迹
            }
            
            currentStep++;
            const progress = Math.min(currentStep / 10, 1) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `预测步骤: ${currentStep}/10 步`;
            
            addLog(`第 ${currentStep} 步: 展示采样轨迹预测...`, 'info');
            
            // 使用最优轨迹的数据来更新当前状态
            if (bestTrajectories && bestTrajectories.length > 0 && bestTrajectories[0].steps[currentStep - 1]) {
                const step = bestTrajectories[0].steps[currentStep - 1];
                currentState.temperature = step.temperature;
                currentState.rPwm = step.rPwm;
                currentState.bPwm = step.bPwm;
                currentState.ppfd = step.ppfd;
                currentState.power = step.power;
                
                const ratio = currentState.bPwm > 0 ? (currentState.rPwm / currentState.bPwm).toFixed(1) : 'N/A';
                addLog(`采样轨迹第 ${currentStep} 步: 温度=${step.temperature.toFixed(2)}°C, R:B=${ratio}, PPFD=${step.ppfd.toFixed(0)}`, 'info');
                
                // 生成采样点用于采样图表显示
                const samples = generateSamplesForDisplay();
                updateSamplingChart(samples);
            }
            
            // 更新显示
            updateDisplay();
            
            if (currentStep >= maxSteps) {
                completeOptimization();
            } else {
                setTimeout(runOptimizationStep, 1000);
            }
        }
        
        // 为显示生成采样点
        function generateSamplesForDisplay() {
            const samples = [];
            const baseR = currentState.rPwm;
            const baseB = currentState.bPwm;
            
            for (let i = 0; i < 50; i++) { // 生成50个点用于显示
                const noiseR = (Math.random() - 0.5) * 30;
                const noiseB = (Math.random() - 0.5) * 30;
                
                const r = Math.max(0, Math.min(100, baseR + noiseR));
                const b = Math.max(0, Math.min(100, baseB + noiseB));
                const cost = calculateStepCost(r, b, currentState.temperature);
                
                samples.push({ r, b, cost });
            }
            
            return samples.sort((a, b) => a.cost - b.cost);
        }
        
        // 更新采样图表
        function updateSamplingChart(samples) {
            const sampleData = samples.map(s => ({x: s.r, y: s.b}));
            const bestSample = samples[0];
            
            samplingChart.data.datasets[0].data = sampleData;
            samplingChart.data.datasets[1].data = [{x: bestSample.r, y: bestSample.b}];
            samplingChart.update('none');
            
            const ratio = bestSample.b > 0 ? (bestSample.r / bestSample.b).toFixed(1) : '∞';
            addLog(`✅ 第 ${currentStep} 步完成: R=${bestSample.r.toFixed(1)}%, B=${bestSample.b.toFixed(1)}%, 比例=${ratio}:1, 成本=${bestSample.cost.toFixed(2)}`, 'success');
        }

        // 更新温度图表
        function updateTemperatureChart() {
            if (!temperatureChart || !temperatureChart.data) return;
            
            // 准备时间标签
            const labels = ['当前'];
            for (let i = 1; i <= 10; i++) {
                labels.push(`${i * 15}分钟`);
            }
            
            // 准备当前状态数据
            const currentData = [currentState.temperature];
            for (let i = 1; i <= 10; i++) {
                currentData.push(null);
            }
            
            // 准备高亮数据（只显示当前点）
            const highlightData = [currentState.temperature];
            for (let i = 1; i <= 10; i++) {
                highlightData.push(null);
            }
            
            // 清除旧的预测轨迹数据集，保留前3个基础数据集
            temperatureChart.data.datasets = temperatureChart.data.datasets.slice(0, 3);
            
            // 添加3条最优预测轨迹
            if (bestTrajectories && bestTrajectories.length >= 3) {
                const colors = [
                    { border: '#ff6b6b', bg: 'rgba(255, 107, 107, 0.1)' }, // 红色 - 最优
                    { border: '#4ecdc4', bg: 'rgba(78, 205, 196, 0.1)' }, // 青色 - 第二优
                    { border: '#45b7d1', bg: 'rgba(69, 183, 209, 0.1)' }  // 蓝色 - 第三优
                ];
                
                bestTrajectories.forEach((trajectory, index) => {
                    if (index < 3) {
                        const trajectoryData = [null]; // 当前点为空
                        trajectory.steps.forEach(step => {
                            trajectoryData.push(step.temperature);
                        });
                        
                        temperatureChart.data.datasets.push({
                            label: `采样轨迹 ${index + 1} (成本: ${trajectory.totalCost.toFixed(1)})`,
                            data: trajectoryData,
                            borderColor: colors[index].border,
                            backgroundColor: colors[index].bg,
                            borderWidth: 2,
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 5
                        });
                    }
                });
            }
            
            // 更新图表
            temperatureChart.data.labels = labels;
            temperatureChart.data.datasets[0].data = currentData; // 当前温度
            temperatureChart.data.datasets[1].data = []; // 清空10步预测数据集
            temperatureChart.data.datasets[2].data = highlightData; // 当前步骤高亮
            
            temperatureChart.update('none');
        }

        // 完成优化
        function completeOptimization() {
            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resetBtn').disabled = false;
            document.getElementById('progressText').textContent = '优化完成！';
            
            addLog('MPPI 优化完成！', 'success');
            addLog(`最终结果: R=${currentState.rPwm.toFixed(1)}%, B=${currentState.bPwm.toFixed(1)}%, PPFD=${currentState.ppfd.toFixed(0)}, 温度=${currentState.temperature.toFixed(1)}°C`, 'success');
        }

        // 暂停动画
        function pauseAnimation() {
            isPaused = !isPaused;
            document.getElementById('pauseBtn').textContent = isPaused ? '继续' : '暂停';
            
            if (!isPaused) {
                runOptimizationStep();
            }
        }

        // 重置演示
        function resetDemo() {
            isRunning = false;
            isPaused = false;
            currentStep = 0;
            
            currentState = {
                temperature: 23.0,
                rPwm: 33.3,
                bPwm: 6.7,
                ppfd: 200,
                power: 30,
                cost: 0
            };
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('resetBtn').disabled = false;
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressText').textContent = '准备开始优化...';
            
            // 清空图表
            samplingChart.data.datasets[0].data = [];
            samplingChart.data.datasets[1].data = [];
            samplingChart.update();
            
            temperatureChart.data.datasets[0].data = Array(16).fill(23);
            temperatureChart.update();
            
            // 清空日志
            document.getElementById('logPanel').innerHTML = '<div class="log-entry">系统重置完成，等待开始优化...</div>';
            
            updateDisplay();
        }

        // 单步执行
        function stepOptimization() {
            if (isRunning) return;
            
            isRunning = true;
            isPaused = true;
            runOptimizationStep();
            isRunning = false;
        }

        // 加载真实的 MPPI 数据
        let demoData = null;
        
        // 异步加载数据
        async function loadDemoData() {
            try {
                const response = await fetch('mppi_demo_data.json');
                if (!response.ok) {
                    throw new Error('无法加载演示数据');
                }
                demoData = await response.json();
                console.log('✅ 成功加载真实 MPPI 数据');
                
                // 数据加载完成后初始化演示
                initializeDemo();
            } catch (error) {
                console.warn('⚠️ 无法加载真实数据，使用模拟数据:', error);
                // 使用模拟数据作为备选
                demoData = {
                    initial_state: {
                        temperature: 23.0,
                        r_pwm: 33.3,
                        b_pwm: 6.7,
                        ppfd: 200,
                        power: 30
                    },
                    optimization_result: {
                        r_pwm: 37.6,
                        b_pwm: 7.5,
                        ppfd: 246,
                        temperature: 23.0,
                        power: 36.0,
                        photosynthesis: 8.2,
                        cost: -82.0,
                        ratio: 5.0
                    },
                    sampling_data: {
                        all_samples: generateSampleData(),
                        best_sample: null,
                        worst_sample: null,
                        num_samples: 300
                    },
                    temperature_predictions: generateTemperatureData(),
                    multi_step_optimization: generateMultiStepData()
                };
                
                // 设置最佳和最差样本
                demoData.sampling_data.all_samples.sort((a, b) => a.cost - b.cost);
                demoData.sampling_data.best_sample = demoData.sampling_data.all_samples[0];
                demoData.sampling_data.worst_sample = demoData.sampling_data.all_samples[demoData.sampling_data.all_samples.length - 1];
                
                initializeDemo();
            }
        }

        // 生成模拟采样数据
        function generateSampleData() {
            const samples = [];
            for (let i = 0; i < 300; i++) {
                const r = Math.random() * 100;
                const b = Math.random() * 20;
                const cost = Math.random() * 200 - 100;
                samples.push({ r_pwm: r, b_pwm: b, cost: cost });
            }
            return samples;
        }

        // 生成模拟温度数据
        function generateTemperatureData() {
            const temps = [];
            let temp = 23.0;
            for (let i = 0; i <= 15; i++) {
                temps.push(temp);
                temp += (Math.random() - 0.5) * 0.5;
            }
            return temps;
        }

        // 生成多步优化数据
        function generateMultiStepData() {
            const steps = [];
            for (let i = 0; i < 10; i++) {
                steps.push({
                    step: i + 1,
                    r_pwm: 33.3 + i * 0.5,
                    b_pwm: 6.7 + i * 0.1,
                    cost: -50 - i * 3
                });
            }
            return steps;
        }

        // 初始化演示
        function initializeDemo() {
            currentStep = 0;
            
            // 如果有真实数据，使用真实的初始状态
            if (demoData && demoData.initial_state) {
                currentState.temperature = demoData.initial_state.temperature;
                currentState.rPwm = demoData.initial_state.r_pwm;
                currentState.bPwm = demoData.initial_state.b_pwm;
                currentState.ppfd = demoData.initial_state.ppfd || 0;
                currentState.power = demoData.initial_state.power || 0;
            }
            
            // 单次MPPI演示：展示内部10步预测
            addLog(`单次MPPI演示 - 展示内部10步温度预测`, 'info');
            addLog(`初始状态: T=${currentState.temperature.toFixed(1)}°C, R=${currentState.rPwm.toFixed(1)}, B=${currentState.bPwm.toFixed(1)}`, 'info');
            
            initCharts();
             
             // 预生成预测曲线用于图表显示
             generatePredictionCurve();
             
             updateDisplay();
             updateTemperatureChart();
            
            // 显示数据来源信息
            const dataSource = demoData && demoData.optimization_result ? '真实 MPPI 数据' : '模拟数据';
            addLog(`📊 使用 ${dataSource} 进行演示`, 'info');
            
            if (demoData && demoData.optimization_result) {
                const result = demoData.optimization_result;
                addLog(`🎯 最优解: R=${result.r_pwm.toFixed(1)}%, B=${result.b_pwm.toFixed(1)}%, 比例=${result.ratio.toFixed(1)}:1`, 'success');
            }
        }

        // 页面加载完成后加载数据
        window.addEventListener('load', function() {
            loadDemoData();
        });
    </script>
</body>
</html>